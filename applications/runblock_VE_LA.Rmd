```{r}

setwd("C:/Users/Gabriel/Documents/Gabriel/IC/R/")

library(terra)
library(sf)
library(rnaturalearth)
library(dplyr)
library(ggplot2)
library(tidyr)

library(tigris)
```

```{r} AEREAL DATA
# Get world PM2.5 concentration
world_data <- c(
  rast("./CA_data/aereal_PM25_CA_2010/aereal_PM25_CA_2010.tif"),
  rast("./CA_data/aereal_PM25_CA_2011/aereal_PM25_CA_2011.tif"),
  rast("./CA_data/aereal_PM25_CA_2012/aereal_PM25_CA_2012.tif")
)

# Instalar e carregar o pacote tigris (se necessário)

# Baixar shapefiles dos condados da Califórnia
ca_counties <- counties(
  state = "CA", 
  year = 2021,       # Ano dos dados
  class = "sf"       # Retornar como objeto sf
)

# Filtrar Ventura e Los Angeles
ventura_la <- ca_counties %>%
  filter(NAME %in% c("Ventura", "Los Angeles"))

# Sincronizar CRS com world_data (exemplo)
ventura_la <- st_transform(ventura_la, crs(world_data))

# Visualizar
ggplot() +
  geom_sf(data = ventura_la, fill = NA, color = "red") +
  theme_minimal()

shapefile <- ne_states(
  country = "United States of America",
  returnclass = "sf"
)

shapefile <- shapefile[shapefile$name == "California", ]

shapefile <- st_transform(shapefile, crs(world_data)) # sync CRS
aerealData <- crop(world_data, shapefile) # crop to fit (?)
aerealData <- mask(aerealData, shapefile) # mask shapefile with data
aerealData <- mean(aerealData, na.rm = TRUE) # get mean

aerealData_sf <- st_as_sf(as.polygons(aerealData$mean))
#  ! use pipe operator
```

```{r} POINT DATA
fileList <- list.files(
  path = "./CA_data/point_PM25_CA_2012", #
  pattern = "\\.csv$",
  full.names = TRUE
)

# Get California point Data
pointData <- lapply(fileList, function(file) {
  f <- st_read(
    file,
    options = c(
      "X_POSSIBLE_NAMES=Site.Longitude",
      "Y_POSSIBLE_NAMES=Site.Latitude"
    ),
    crs = 4326 # Define o CRS como WGS84
  )
  return(f)
})

#  Get mean values
#  Cada estação possuí várias medidas ao longo do ano, o que faremos é tirar a média de todas
#  as medidas dentro de um ano, e então tirar a média de todos os anos, assim, cada estação
#  terá apenas uma medida, que é a média total

#  "Daily.Mean.PM2.5.Concentration", "Site.Latitude", "Site.Longitude"

annual_means <- lapply(pointData, function(df) {
  # Converter para numérico se necessário
  if (!is.numeric(df$Daily.Mean.PM2.5.Concentration)) {
    df$Daily.Mean.PM2.5.Concentration <- as.numeric(as.character(
      df$Daily.Mean.PM2.5.Concentration
    ))
  }

  # Calcular médias por estação
  result <- df %>%
    group_by(Site.Latitude, Site.Longitude, Site.ID) %>%
    summarise(
      Annual_Mean = mean(Daily.Mean.PM2.5.Concentration, na.rm = TRUE),
      Count = sum(!is.na(Daily.Mean.PM2.5.Concentration)),
      .groups = "drop"
    )

  # Converter para objeto sf com geometria
  if (inherits(df, "sf")) {
    result <- st_as_sf(
      result,
      coords = c("Site.Longitude", "Site.Latitude"),
      crs = st_crs(df)
    )
  } else {
    # Se não for objeto sf, criar geometria manualmente
    result <- st_as_sf(
      result,
      coords = c("Site.Longitude", "Site.Latitude"),
      crs = 4326 # WGS84 como sistema padrão
    )
  }

  return(result)
})

all_stations <- do.call(rbind, annual_means)

#  Get total mean
pointData_df <- all_stations %>%
  group_by(Site.ID) %>%
  summarise(
    mean = mean(Annual_Mean, na.rm = TRUE),
    .groups = "drop"
  )
```

```{r} Join aereal and point data to get mixed data
mixedData_sf <- bind_rows(
  aerealData = select(aerealData_sf, mean, geometry),
  pointData = select(pointData_df, mean, geometry),
  .id = "type"
)
```

```{r} Plot mixed data
ggplot() +
  geom_sf(data = mixedData_sf, aes(color = mean, fill=mean)) +
  labs(title = "") +
  theme_minimal() 
```


