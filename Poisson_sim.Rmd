```{r}
rm(list = ls())
dir.save <- getwd()

library(INLA)
library(mvtnorm)
library(tidyverse)
library(sf)
library(units)


library(CARBayesdata)
data(GGHB.IZ)
data(respiratorydata)

```

```{r} set spatial parameters
M <- 20
B <- as.matrix(c(-0.2, 0.35))
sigma.sq <- 0.19
rho <- 2.25
alpha <- 0.7
phi <- rho / (log(10)^(1 / alpha))


source("blockNNGPrgeneric.R")
source("Irregblock.R")
```

```{r}
sf <- GGHB.IZ[GGHB.IZ$IZ %in% respiratorydata$IZ, ]["geometry"]
n <- nrow(sf)

plot(sf)

distMatrix <- st_distance(sf, which = "Hausdorff") |>
  units::set_units(value = NULL) |>
  as.matrix()

R <- exp((-1) * (distMatrix / phi)^alpha)
diag(R) <- 1
C <- sigma.sq * R

D <- chol(C)
# set.seed(1232)

p <- length(B)

X <- as.matrix(cbind(1, scale(respiratorydata$incomedep))) ## X = intercept + covariate

E <- respiratorydata$expected # offset

w <- t(matrix(rnorm(n), ncol = (n)) %*% D)
eta <- X %*% B
lambda <- E * exp(eta + w)
y <- rpois(n, lambda)
```


```{r} Generate HGP model
source("utils.R")


D = st_distance(sf)
b = max(D) / 2

priors = list(a = 0, b = b)


n.partition <- 8
n.blocks <- n.partition^2
num.nb <- 2
HGPdata <- get_HGPdata(sf, y, X, n.blocks, num.nb, alpha, priors)


blockNNGP.model <- HGPdata$model
```


```{r} Run model with INLA'
out <- matrix(0, ncol = 4, nrow = M)

# Xnew <- X[(HGPdata$order), ]
# Enew <- E[(HGPdata$order)]
# y <- y[(HGPdata$order)]

for (i in 1:M) {
  set.seed(i)
  print(i)

  data1 <- data.frame(y = y, x = X[, 2])
  data1$idx <- 1:nrow(data1)

  f.blockNNGP <- y ~ 1 + x + f(idx, model = blockNNGP.model)

  resf <- inla(
    f.blockNNGP,
    data = as.data.frame(data1),
    family = "poisson",
    E = E
  )

  # summary(resf)

  sigmasq.est <- inla.emarginal(
    function(x) exp(-x),
    resf$marginals.hyperpar[[1]]
  )
  phi.est <- inla.emarginal(
    function(x) 1 - 1 / (1 + exp(x)),
    resf$marginals.hyperpar[[2]]
  )
  rho.est <- log(10)^(1 / (alpha)) * phi.est

  # Resultado transformado
  cat("σ²:", sigmasq.est, "\n")
  cat("ϕ:", phi.est, "\n")
  cat("ρ:", rho.est, "\n")
  summary(resf)
  names(out) = c("B1", "B2", "sigmasq.est", "phi.est")
  out[i, ] <- c(resf$summary.fixed[, 1], sigmasq.est, phi.est)
}

print("CASO POISSON")
summary(out)

```
